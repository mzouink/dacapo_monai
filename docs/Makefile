# Makefile for DaCapo-MONAI documentation

# You can set these variables from the command line, and also from the environment
SPHINXOPTS    ?=
SPHINXBUILD  ?= sphinx-build
SOURCEDIR    = .
BUILDDIR     = _build

# Default target
help:
	@$(SPHINXBUILD) -M help "$(SOURCEDIR)" "$(BUILDDIR)" $(SPHINXOPTS)

.PHONY: help clean html pdf linkcheck livehtml install deps

# Clean build directory
clean:
	@echo "ğŸ§¹ Cleaning build directory..."
	rm -rf $(BUILDDIR)/*
	@echo "âœ… Clean completed!"

# Install documentation dependencies
install:
	@echo "ğŸ“¦ Installing documentation dependencies..."
	pip install -e "../[docs]"
	@echo "âœ… Dependencies installed!"

# Install just docs dependencies
deps:
	@echo "ğŸ“¦ Installing Sphinx and extensions..."
	pip install sphinx sphinx-design furo myst-parser sphinx-copybutton sphinxcontrib-mermaid sphinx-autobuild
	@echo "âœ… Documentation dependencies installed!"

# Build HTML documentation
html: deps
	@echo "ğŸ”¨ Building HTML documentation..."
	@$(SPHINXBUILD) -b html "$(SOURCEDIR)" "$(BUILDDIR)/html" $(SPHINXOPTS)
	@echo "âœ… HTML documentation built successfully!"
	@echo "ğŸ“– Open $(BUILDDIR)/html/index.html in your browser"

# Build PDF documentation
pdf: deps
	@echo "ğŸ”¨ Building PDF documentation..."
	@$(SPHINXBUILD) -b latex "$(SOURCEDIR)" "$(BUILDDIR)/latex" $(SPHINXOPTS)
	@echo "ğŸ“„ LaTeX files generated, building PDF..."
	@cd $(BUILDDIR)/latex && make all-pdf
	@echo "âœ… PDF documentation built successfully!"
	@echo "ğŸ“„ PDF available at $(BUILDDIR)/latex/dacapo-monai.pdf"

# Check for broken links
linkcheck: deps
	@echo "ğŸ”— Checking for broken links..."
	@$(SPHINXBUILD) -b linkcheck "$(SOURCEDIR)" "$(BUILDDIR)/linkcheck" $(SPHINXOPTS)
	@echo "âœ… Link check completed!"

# Live reload development server
livehtml: deps
	@echo "ğŸš€ Starting live documentation server..."
	@echo "ğŸ“– Documentation will be available at http://localhost:8000"
	@echo "ğŸ’¡ Press Ctrl+C to stop the server"
	sphinx-autobuild "$(SOURCEDIR)" "$(BUILDDIR)/html" --host 0.0.0.0 --port 8000

# Build all formats
all: clean html pdf
	@echo "ğŸ‰ All documentation formats built successfully!"

# Quick build (HTML only, no dependency check)
quick:
	@echo "âš¡ Quick HTML build..."
	@$(SPHINXBUILD) -b html "$(SOURCEDIR)" "$(BUILDDIR)/html" $(SPHINXOPTS)
	@echo "âœ… Quick build completed!"

# Serve built documentation
serve:
	@echo "ğŸŒ Serving documentation at http://localhost:8080"
	@echo "ğŸ’¡ Press Ctrl+C to stop the server"
	@cd $(BUILDDIR)/html && python -m http.server 8080

# Development workflow
dev: clean livehtml

# CI workflow  
ci: clean html linkcheck
	@echo "ğŸ¤– CI documentation build completed!"

# Generate API documentation
api:
	@echo "ğŸ”§ Generating API documentation..."
	sphinx-apidoc -o api_reference ../src/dacapo_monai --force --separate
	@echo "âœ… API documentation generated!"

# Spell check (requires aspell)
spellcheck:
	@echo "ğŸ”¤ Spell checking documentation..."
	@find . -name "*.md" -exec aspell --mode=sgml --check {} \; || echo "âš ï¸ aspell not installed, skipping spell check"

# Statistics
stats:
	@echo "ğŸ“Š Documentation Statistics:"
	@echo "ğŸ“„ Markdown files: $$(find . -name '*.md' | wc -l)"
	@echo "ğŸ“„ reStructuredText files: $$(find . -name '*.rst' | wc -l)"
	@echo "ğŸ“„ Total lines: $$(find . -name '*.md' -o -name '*.rst' | xargs wc -l | tail -1)"
	@if [ -d "$(BUILDDIR)/html" ]; then \
		echo "ğŸŒ Generated HTML files: $$(find $(BUILDDIR)/html -name '*.html' | wc -l)"; \
		echo "ğŸ“¦ Build size: $$(du -sh $(BUILDDIR)/html | cut -f1)"; \
	fi

# Help with common tasks
info:
	@echo "ğŸ“š DaCapo-MONAI Documentation Build System"
	@echo ""
	@echo "ğŸ“‹ Common Commands:"
	@echo "  make install     - Install documentation dependencies"
	@echo "  make html        - Build HTML documentation"
	@echo "  make livehtml    - Start live reload server for development"  
	@echo "  make pdf         - Build PDF documentation"
	@echo "  make linkcheck   - Check for broken links"
	@echo "  make clean       - Clean build directory"
	@echo "  make serve       - Serve built documentation"
	@echo "  make stats       - Show documentation statistics"
	@echo ""
	@echo "ğŸ”§ Development:"
	@echo "  make dev         - Clean build and start live server"
	@echo "  make quick       - Quick HTML build without dependency check"
	@echo "  make api         - Generate API documentation"
	@echo ""
	@echo "ğŸ¤– CI/CD:"
	@echo "  make ci          - Full CI build with link checking"
	@echo ""
	@echo "ğŸ’¡ For more options, run 'make help'"

# Default target when no specific target is provided
.DEFAULT_GOAL := info